pub mod arc_button;
pub mod arc_no_fill_button;
pub mod arrow_button;
pub mod box_button;
pub mod box_no_fill_button;
pub mod color_button; // fare unico tasto?
pub mod copy_screenshot_button;
pub mod freehand_button;
pub mod fullscreen_button;
pub mod line_button;
pub mod numbered_circle_button;
pub mod save_screenshot_button;
pub mod screen_recorder;
pub mod settings_button;

use crate::geometry::GeometryState;
use gtk::prelude::*;
use rustshot_gtk::constants::CSS_CLASS_PRESSED;

pub trait ToolboxWidgetExt {
    fn widget(&self) -> &gtk::Widget;
    fn css_classes(&self) -> gtk::StyleContext; // shortcut to the style‑context
    fn add_css_class(&self, class: &str);
    fn remove_css_class(&self, class: &str);
    fn parent(&self) -> Option<gtk::Widget>;
}

/*  Implement the trait for each concrete button type.  The concrete
types (`ScreenRecorder` and `BoxButton`) are assumed to be
`gtk::Widget` subclasses, therefore we can safely cast them to
`gtk:Widget`.  If they are not, adjust the casts accordingly. */
impl ToolboxWidgetExt for screen_recorder::ScreenRecorder {
    fn widget(&self) -> &gtk::Widget {
        self.upcast_ref()
    }
    fn parent(&self) -> Option<gtk::Widget> {
        self.widget().parent()
    }
    fn css_classes(&self) -> gtk::StyleContext {
        self.widget().style_context()
    }
    fn add_css_class(&self, class: &str) {
        self.widget().add_css_class(class);
    }
    fn remove_css_class(&self, class: &str) {
        self.widget().remove_css_class(class);
    }
}

impl ToolboxWidgetExt for arrow_button::ArrowButton {
    fn widget(&self) -> &gtk::Widget {
        self.upcast_ref()
    }
    fn parent(&self) -> Option<gtk::Widget> {
        self.widget().parent()
    }
    fn css_classes(&self) -> gtk::StyleContext {
        self.widget().style_context()
    }
    fn add_css_class(&self, class: &str) {
        self.widget().add_css_class(class);
    }
    fn remove_css_class(&self, class: &str) {
        self.widget().remove_css_class(class);
    }
}

impl ToolboxWidgetExt for arc_no_fill_button::ArcNoFillButton {
    fn widget(&self) -> &gtk::Widget {
        self.upcast_ref()
    }
    fn parent(&self) -> Option<gtk::Widget> {
        self.widget().parent()
    }
    fn css_classes(&self) -> gtk::StyleContext {
        self.widget().style_context()
    }
    fn add_css_class(&self, class: &str) {
        self.widget().add_css_class(class);
    }
    fn remove_css_class(&self, class: &str) {
        self.widget().remove_css_class(class);
    }
}

impl ToolboxWidgetExt for arc_button::ArcButton {
    fn widget(&self) -> &gtk::Widget {
        self.upcast_ref()
    }
    fn parent(&self) -> Option<gtk::Widget> {
        self.widget().parent()
    }
    fn css_classes(&self) -> gtk::StyleContext {
        self.widget().style_context()
    }
    fn add_css_class(&self, class: &str) {
        self.widget().add_css_class(class);
    }
    fn remove_css_class(&self, class: &str) {
        self.widget().remove_css_class(class);
    }
}

impl ToolboxWidgetExt for box_no_fill_button::BoxNoFillButton {
    fn widget(&self) -> &gtk::Widget {
        self.upcast_ref()
    }
    fn parent(&self) -> Option<gtk::Widget> {
        self.widget().parent()
    }
    fn css_classes(&self) -> gtk::StyleContext {
        self.widget().style_context()
    }
    fn add_css_class(&self, class: &str) {
        self.widget().add_css_class(class);
    }
    fn remove_css_class(&self, class: &str) {
        self.widget().remove_css_class(class);
    }
}

impl ToolboxWidgetExt for box_button::BoxButton {
    fn widget(&self) -> &gtk::Widget {
        self.upcast_ref()
    }
    fn parent(&self) -> Option<gtk::Widget> {
        self.widget().parent()
    }
    fn css_classes(&self) -> gtk::StyleContext {
        self.widget().style_context()
    }
    fn add_css_class(&self, class: &str) {
        self.widget().add_css_class(class);
    }
    fn remove_css_class(&self, class: &str) {
        self.widget().remove_css_class(class);
    }
}

impl ToolboxWidgetExt for freehand_button::FreehandButton {
    fn widget(&self) -> &gtk::Widget {
        self.upcast_ref()
    }
    fn parent(&self) -> Option<gtk::Widget> {
        self.widget().parent()
    }
    fn css_classes(&self) -> gtk::StyleContext {
        self.widget().style_context()
    }
    fn add_css_class(&self, class: &str) {
        self.widget().add_css_class(class);
    }
    fn remove_css_class(&self, class: &str) {
        self.widget().remove_css_class(class);
    }
}

impl ToolboxWidgetExt for numbered_circle_button::NumberedCircleButton {
    fn widget(&self) -> &gtk::Widget {
        self.upcast_ref()
    }
    fn parent(&self) -> Option<gtk::Widget> {
        self.widget().parent()
    }
    fn css_classes(&self) -> gtk::StyleContext {
        self.widget().style_context()
    }
    fn add_css_class(&self, class: &str) {
        self.widget().add_css_class(class);
    }
    fn remove_css_class(&self, class: &str) {
        self.widget().remove_css_class(class);
    }
}

impl ToolboxWidgetExt for settings_button::SettingsButton {
    fn widget(&self) -> &gtk::Widget {
        self.upcast_ref()
    }
    fn parent(&self) -> Option<gtk::Widget> {
        self.widget().parent()
    }
    fn css_classes(&self) -> gtk::StyleContext {
        self.widget().style_context()
    }
    fn add_css_class(&self, class: &str) {
        self.widget().add_css_class(class);
    }
    fn remove_css_class(&self, class: &str) {
        self.widget().remove_css_class(class);
    }
}

impl ToolboxWidgetExt for color_button::ColorButton {
    fn widget(&self) -> &gtk::Widget {
        self.upcast_ref()
    }
    fn parent(&self) -> Option<gtk::Widget> {
        self.widget().parent()
    }
    fn css_classes(&self) -> gtk::StyleContext {
        self.widget().style_context()
    }
    fn add_css_class(&self, class: &str) {
        self.widget().add_css_class(class);
    }
    fn remove_css_class(&self, class: &str) {
        self.widget().remove_css_class(class);
    }
}

impl ToolboxWidgetExt for line_button::LineButton {
    fn widget(&self) -> &gtk::Widget {
        self.upcast_ref()
    }
    fn parent(&self) -> Option<gtk::Widget> {
        self.widget().parent()
    }
    fn css_classes(&self) -> gtk::StyleContext {
        self.widget().style_context()
    }
    fn add_css_class(&self, class: &str) {
        self.widget().add_css_class(class);
    }
    fn remove_css_class(&self, class: &str) {
        self.widget().remove_css_class(class);
    }
}

impl ToolboxWidgetExt for copy_screenshot_button::CopyScreenshotButton {
    fn widget(&self) -> &gtk::Widget {
        self.upcast_ref()
    }
    fn parent(&self) -> Option<gtk::Widget> {
        self.widget().parent()
    }
    fn css_classes(&self) -> gtk::StyleContext {
        self.widget().style_context()
    }
    fn add_css_class(&self, class: &str) {
        self.widget().add_css_class(class);
    }
    fn remove_css_class(&self, class: &str) {
        self.widget().remove_css_class(class);
    }
}

impl ToolboxWidgetExt for fullscreen_button::FullscreenButton {
    fn widget(&self) -> &gtk::Widget {
        self.upcast_ref()
    }
    fn parent(&self) -> Option<gtk::Widget> {
        self.widget().parent()
    }
    fn css_classes(&self) -> gtk::StyleContext {
        self.widget().style_context()
    }
    fn add_css_class(&self, class: &str) {
        self.widget().add_css_class(class);
    }
    fn remove_css_class(&self, class: &str) {
        self.widget().remove_css_class(class);
    }
}

impl ToolboxWidgetExt for save_screenshot_button::SaveScreenshotButton {
    fn widget(&self) -> &gtk::Widget {
        self.upcast_ref()
    }
    fn parent(&self) -> Option<gtk::Widget> {
        self.widget().parent()
    }
    fn css_classes(&self) -> gtk::StyleContext {
        self.widget().style_context()
    }
    fn add_css_class(&self, class: &str) {
        self.widget().add_css_class(class);
    }
    fn remove_css_class(&self, class: &str) {
        self.widget().remove_css_class(class);
    }
}

impl ToolboxWidgetExt for ToolboxButton {
    fn widget(&self) -> &gtk::Widget {
        match self {
            ToolboxButton::ScreenRecord(w) => w.widget(),
            ToolboxButton::BoxButton(w) => w.widget(),
            ToolboxButton::BoxNoFillButton(w) => w.widget(),
            ToolboxButton::ArcButton(w) => w.widget(),
            ToolboxButton::ArcNoFillButton(w) => w.widget(),
            ToolboxButton::ArrowButton(w) => w.widget(),
            ToolboxButton::FreehandButton(w) => w.widget(),
            ToolboxButton::NumberedCircleButton(w) => w.widget(),
            ToolboxButton::SettingsButton(w) => w.widget(),
            ToolboxButton::ColorButton(w) => w.widget(),
            ToolboxButton::LineButton(w) => w.widget(),
            ToolboxButton::CopyScreenshotButton(w) => w.widget(),
            ToolboxButton::FullscreenButton(w) => w.widget(),
            ToolboxButton::SaveScreenshotButton(w) => w.widget(),
        }
    }
    fn parent(&self) -> Option<gtk::Widget> {
        match self {
            ToolboxButton::ScreenRecord(w) => Self::parent(&ToolboxButton::ScreenRecord(w.clone())),
            ToolboxButton::BoxButton(w) => Self::parent(&ToolboxButton::BoxButton(w.clone())),
            ToolboxButton::BoxNoFillButton(w) => {
                Self::parent(&ToolboxButton::BoxNoFillButton(w.clone()))
            }
            ToolboxButton::ArcButton(w) => Self::parent(&ToolboxButton::ArcButton(w.clone())),
            ToolboxButton::ArcNoFillButton(w) => {
                Self::parent(&ToolboxButton::ArcNoFillButton(w.clone()))
            }
            ToolboxButton::ArrowButton(w) => Self::parent(&ToolboxButton::ArrowButton(w.clone())),
            ToolboxButton::FreehandButton(w) => {
                Self::parent(&ToolboxButton::FreehandButton(w.clone()))
            }
            ToolboxButton::NumberedCircleButton(w) => {
                Self::parent(&ToolboxButton::NumberedCircleButton(w.clone()))
            }
            ToolboxButton::SettingsButton(w) => {
                Self::parent(&ToolboxButton::SettingsButton(w.clone()))
            }
            ToolboxButton::ColorButton(w) => Self::parent(&ToolboxButton::ColorButton(w.clone())),
            ToolboxButton::LineButton(w) => Self::parent(&ToolboxButton::LineButton(w.clone())),
            ToolboxButton::CopyScreenshotButton(w) => {
                Self::parent(&ToolboxButton::CopyScreenshotButton(w.clone()))
            }
            ToolboxButton::FullscreenButton(w) => {
                Self::parent(&ToolboxButton::FullscreenButton(w.clone()))
            }
            ToolboxButton::SaveScreenshotButton(w) => {
                Self::parent(&ToolboxButton::SaveScreenshotButton(w.clone()))
            }
        }
    }
    fn css_classes(&self) -> gtk::StyleContext {
        match self {
            ToolboxButton::ScreenRecord(w) => {
                Self::css_classes(&ToolboxButton::ScreenRecord(w.clone()))
            }
            ToolboxButton::BoxButton(w) => Self::css_classes(&ToolboxButton::BoxButton(w.clone())),
            ToolboxButton::BoxNoFillButton(w) => {
                Self::css_classes(&ToolboxButton::BoxNoFillButton(w.clone()))
            }
            ToolboxButton::ArcButton(w) => Self::css_classes(&ToolboxButton::ArcButton(w.clone())),
            ToolboxButton::ArcNoFillButton(w) => {
                Self::css_classes(&ToolboxButton::ArcNoFillButton(w.clone()))
            }
            ToolboxButton::ArrowButton(w) => {
                Self::css_classes(&ToolboxButton::ArrowButton(w.clone()))
            }
            ToolboxButton::FreehandButton(w) => {
                Self::css_classes(&ToolboxButton::FreehandButton(w.clone()))
            }
            ToolboxButton::NumberedCircleButton(w) => {
                Self::css_classes(&ToolboxButton::NumberedCircleButton(w.clone()))
            }
            ToolboxButton::SettingsButton(w) => {
                Self::css_classes(&ToolboxButton::SettingsButton(w.clone()))
            }
            ToolboxButton::ColorButton(w) => {
                Self::css_classes(&ToolboxButton::ColorButton(w.clone()))
            }
            ToolboxButton::LineButton(w) => {
                Self::css_classes(&ToolboxButton::LineButton(w.clone()))
            }
            ToolboxButton::CopyScreenshotButton(w) => {
                Self::css_classes(&ToolboxButton::CopyScreenshotButton(w.clone()))
            }
            ToolboxButton::FullscreenButton(w) => {
                Self::css_classes(&ToolboxButton::FullscreenButton(w.clone()))
            }
            ToolboxButton::SaveScreenshotButton(w) => {
                Self::css_classes(&ToolboxButton::SaveScreenshotButton(w.clone()))
            }
        }
    }
    fn add_css_class(&self, class: &str) {
        match self {
            ToolboxButton::ScreenRecord(w) => {
                Self::add_css_class(&ToolboxButton::ScreenRecord(w.clone()), class)
            }
            ToolboxButton::BoxButton(w) => {
                Self::add_css_class(&ToolboxButton::BoxButton(w.clone()), class)
            }
            ToolboxButton::BoxNoFillButton(w) => {
                Self::add_css_class(&ToolboxButton::BoxNoFillButton(w.clone()), class)
            }
            ToolboxButton::ArcButton(w) => {
                Self::add_css_class(&ToolboxButton::ArcButton(w.clone()), class)
            }
            ToolboxButton::ArcNoFillButton(w) => {
                Self::add_css_class(&ToolboxButton::ArcNoFillButton(w.clone()), class)
            }
            ToolboxButton::ArrowButton(w) => {
                Self::add_css_class(&ToolboxButton::ArrowButton(w.clone()), class)
            }
            ToolboxButton::FreehandButton(w) => {
                Self::add_css_class(&ToolboxButton::FreehandButton(w.clone()), class)
            }
            ToolboxButton::NumberedCircleButton(w) => {
                Self::add_css_class(&ToolboxButton::NumberedCircleButton(w.clone()), class)
            }
            ToolboxButton::SettingsButton(w) => {
                Self::add_css_class(&ToolboxButton::SettingsButton(w.clone()), class)
            }
            ToolboxButton::ColorButton(w) => {
                Self::add_css_class(&ToolboxButton::ColorButton(w.clone()), class)
            }
            ToolboxButton::LineButton(w) => {
                Self::add_css_class(&ToolboxButton::LineButton(w.clone()), class)
            }
            ToolboxButton::CopyScreenshotButton(w) => {
                Self::add_css_class(&ToolboxButton::CopyScreenshotButton(w.clone()), class)
            }
            ToolboxButton::FullscreenButton(w) => {
                Self::add_css_class(&ToolboxButton::FullscreenButton(w.clone()), class)
            }
            ToolboxButton::SaveScreenshotButton(w) => {
                Self::add_css_class(&ToolboxButton::SaveScreenshotButton(w.clone()), class)
            }
        }
    }
    fn remove_css_class(&self, class: &str) {
        match self {
            ToolboxButton::ScreenRecord(w) => {
                Self::remove_css_class(&ToolboxButton::ScreenRecord(w.clone()), class)
            }
            ToolboxButton::BoxButton(w) => {
                Self::remove_css_class(&ToolboxButton::BoxButton(w.clone()), class)
            }
            ToolboxButton::BoxNoFillButton(w) => {
                Self::remove_css_class(&ToolboxButton::BoxNoFillButton(w.clone()), class)
            }
            ToolboxButton::ArcButton(w) => {
                Self::remove_css_class(&ToolboxButton::ArcButton(w.clone()), class)
            }
            ToolboxButton::ArcNoFillButton(w) => {
                Self::remove_css_class(&ToolboxButton::ArcNoFillButton(w.clone()), class)
            }
            ToolboxButton::ArrowButton(w) => {
                Self::remove_css_class(&ToolboxButton::ArrowButton(w.clone()), class)
            }
            ToolboxButton::FreehandButton(w) => {
                Self::remove_css_class(&ToolboxButton::FreehandButton(w.clone()), class)
            }
            ToolboxButton::NumberedCircleButton(w) => {
                Self::remove_css_class(&ToolboxButton::NumberedCircleButton(w.clone()), class)
            }
            ToolboxButton::SettingsButton(w) => {
                Self::remove_css_class(&ToolboxButton::SettingsButton(w.clone()), class)
            }
            ToolboxButton::ColorButton(w) => {
                Self::remove_css_class(&ToolboxButton::ColorButton(w.clone()), class)
            }
            ToolboxButton::LineButton(w) => {
                Self::remove_css_class(&ToolboxButton::LineButton(w.clone()), class)
            }
            ToolboxButton::CopyScreenshotButton(w) => {
                Self::remove_css_class(&ToolboxButton::CopyScreenshotButton(w.clone()), class)
            }
            ToolboxButton::FullscreenButton(w) => {
                Self::remove_css_class(&ToolboxButton::FullscreenButton(w.clone()), class)
            }
            ToolboxButton::SaveScreenshotButton(w) => {
                Self::remove_css_class(&ToolboxButton::SaveScreenshotButton(w.clone()), class)
            }
        }
    }
}

/*  The enum now only serves as a *tag* that tells us which concrete
button we are dealing with.  All behaviour is delegated to the
`ToolboxWidgetExt` implementation via a small helper method. */
#[derive(Debug)]
pub enum ToolboxButton {
    ScreenRecord(screen_recorder::ScreenRecorder),
    BoxButton(box_button::BoxButton),
    BoxNoFillButton(box_no_fill_button::BoxNoFillButton),
    ArcButton(arc_button::ArcButton),
    ArcNoFillButton(arc_no_fill_button::ArcNoFillButton),
    ArrowButton(arrow_button::ArrowButton),
    FreehandButton(freehand_button::FreehandButton),
    NumberedCircleButton(numbered_circle_button::NumberedCircleButton),
    SettingsButton(settings_button::SettingsButton),
    ColorButton(color_button::ColorButton),
    LineButton(line_button::LineButton),
    CopyScreenshotButton(copy_screenshot_button::CopyScreenshotButton),
    FullscreenButton(fullscreen_button::FullscreenButton),
    SaveScreenshotButton(save_screenshot_button::SaveScreenshotButton),
}

impl ToolboxButton {
    /// Return a reference that implements the unified widget helpers.
    fn as_ext(&self) -> &dyn ToolboxWidgetExt {
        match self {
            ToolboxButton::ScreenRecord(btn) => btn,
            ToolboxButton::BoxButton(btn) => btn,
            ToolboxButton::BoxNoFillButton(btn) => btn,
            ToolboxButton::ArcButton(btn) => btn,
            ToolboxButton::ArcNoFillButton(btn) => btn,
            ToolboxButton::ArrowButton(btn) => btn,
            ToolboxButton::FreehandButton(btn) => btn,
            ToolboxButton::NumberedCircleButton(btn) => btn,
            ToolboxButton::SettingsButton(btn) => btn,
            ToolboxButton::ColorButton(btn) => btn,
            ToolboxButton::LineButton(btn) => btn,
            ToolboxButton::CopyScreenshotButton(btn) => btn,
            ToolboxButton::FullscreenButton(btn) => btn,
            ToolboxButton::SaveScreenshotButton(btn) => btn,
        }
    }
}

fn toggle_drawing<F>(button: &ToolboxButton, geom: &GeometryState, start_draw: F)
where
    F: FnOnce(),
{
    // ---------------------------------------------------------
    // 1️⃣  If we are already drawing, stop it.
    // ---------------------------------------------------------
    if geom.toolbox.is_button_pressed() {
        geom.screenshot_box.set_screenshot_box_sensitivity(true);
        geom.drawing.set_drawing(false);
        geom.toolbox.set_button_pressed(false);
        geom.settings_window.set_visible(false);

        // If the button itself still carries the “pressed” CSS class,
        // just toggle it off and exit early.
        if button.as_ext().css_classes().has_class(CSS_CLASS_PRESSED) {
            button.as_ext().remove_css_class(CSS_CLASS_PRESSED);
            return;
        }

        // Otherwise another button was clicked – clear the old toolbox
        // highlight.
        geom.toolbox.remove_css_class(CSS_CLASS_PRESSED);
    }

    // ---------------------------------------------------------
    // 2️⃣  Begin a fresh drawing operation.
    // ---------------------------------------------------------
    geom.screenshot_box.set_screenshot_box_sensitivity(false);
    start_draw(); // ← caller creates the specific shape
    geom.toolbox.set_button_pressed(true);
    button.as_ext().add_css_class(CSS_CLASS_PRESSED);
}
